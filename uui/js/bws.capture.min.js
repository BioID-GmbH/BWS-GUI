/*! BioID Web Service - 2018-10-29
*   image capture and recognition library - v2.1.0
*   https://www.bioid.com
*   Copyright (C) BioID GmbH.
*/
!function(e,t,i){"use strict";e.initcapture=function(e,i,o){var n=t.extend({},{apiurl:"https://bws.bioid.com/extension/",task:"verification",trait:"FACE",maxheight:480,recordings:2,maxupload:20,challengeResponse:!1,motionareaheight:160,threshold:25,mirror:!0},o);void 0!==n.host&&(n.apiurl="https://"+n.host+"/extension/");var r=e;r||alert("Please provide a valid canvas element to initialize the BWS capture module!");var a=i,l=document.createElement("video");l.setAttribute("playsinline","");var h,d,s,c,g,u,f=document.createElement("canvas"),p=document.createElement("canvas"),w=null,m=0,v=0,x=0,b=!1,y="any",I=[],P=function(){console.log("Pausing capture..."),T(!1),l.pause(),clearInterval(d),h=null},U=function(){let e=f.getContext("2d");e.translate(f.width,0),e.scale(-1,1)};function E(){g&&g("UserInstruction-Start"),T(!0),function e(){clearInterval(c);c=setInterval(function(){0===v?(P(),u("Activity time is over!")):e()},3e4)}()}function T(e){clearInterval(s),clearInterval(c),m=0,v=0,x=0,w=null,b=e}function k(){let e=0,t=0,i=f.width,o=f.height,a=i/o,h=l.videoWidth-l.videoHeight*a,d=r.getContext("2d");f.getContext("2d").drawImage(l,h/2,0,l.videoWidth-h,l.videoHeight,0,0,f.width,f.height),r.width=r.clientWidth,r.height=r.clientHeight,d.fillStyle="white",d.fillRect(0,0,r.width,r.height),r.width/r.height>a?(t=0,i=(o=r.height)*a,e=(r.width-i)/2):(e=0,o=(i=r.width)/a,t=(r.height-o)/2),d.drawImage(f,0,0,f.width,f.height,e,t,i,o);let s=d.createRadialGradient(r.width/2*1/.8,r.height/2*1/1.1,0,r.width/2*1/.8,r.height/2*1/1.1,.5*i);if(s.addColorStop(.98,"transparent"),s.addColorStop(.99,"rgba(255, 255, 255, 1)"),d.fillStyle=s,d.setTransform(.8,0,0,1.1,0,0),d.fillRect(0,0,1*r.width/.8,1*r.height/1.1),b&&m<n.recordings){x>n.maxupload&&(P(),u("The maximum number of uploads has been reached!"));let e=p.getContext("2d");e.drawImage(f,f.width/8,f.height/8,f.width-f.width/4,f.height-f.height/4,0,0,p.width,p.height);let t=e.getImageData(0,0,p.width,p.height),i=100;w&&(i=function(e,t){let i=0,o=0,n=0,r=e.width/4,a=e.height/4,l=e.data;for(let h=t.centerY-a;h<=t.centerY+a-t.height;h++)for(let a=t.centerX-r;a<=t.centerX+r-t.width;a++){let r=0,d=0,s=0;for(let i=0;i<t.height;i++){let o=4*a+1+(h+i)*e.width*4;for(let e=0;e<t.width;e++){let e=l[o];r+=t.buffer[s++]*e,d+=e*e,o+=4}}let c=0;d>0&&(c=r*r/d),c>n&&(n=c,i=a,o=h)}let h=i-t.xPos,d=o-t.yPos,s=Math.sqrt(h*h+d*d),c=r-t.width/2,g=a-t.height/2,u=Math.sqrt(c*c+g*g);var f=s/u*100;f>100&&(f=100);return f}(t,w)),i>n.threshold&&m+v<n.recordings&&(R(),w=function(e){var t={centerX:e.width/2,centerY:e.height/2,width:e.width/4,height:e.height/4+e.height/8};t.xPos=t.centerX-t.width/2,t.yPos=t.centerY-t.height/2,t.buffer=new Uint8ClampedArray(t.width*t.height);let i=0,o=e.data;for(let n=t.yPos;n<t.yPos+t.height;n++){let r=n*e.width*4+4*t.xPos+1;for(let e=t.xPos;e<t.xPos+t.width;e++){let e=o[r];t.buffer[i++]=e,r+=4}}return console.log("Created new cross-correlation template",t),t}(t))}}function R(){if(clearInterval(s),s=setInterval(function(){v+m<n.recordings&&g&&g("UserInstruction-NoMovement")},5e3),b&&m+v<n.recordings){x++,v++;let e=f.toDataURL();console.log("sizeof dataURL",e.length),g&&g("Uploading"),t.support.cors||console.log("this browser does not support cors, e.g. IE8 or 9");t.ajax({type:"POST",url:n.apiurl+"upload?tag="+y+"&index="+x+"&trait="+n.trait,data:e,headers:{Authorization:"Bearer "+a},xhr:function(){var e=new window.XMLHttpRequest;return e.upload.id=x,e.upload.addEventListener("progress",function(e){let t=0;if(e.lengthComputable){t=Math.ceil(e.loaded/e.total*100);let i={id:this.id,progress:t};g&&g("UploadProgress",i)}},!1),e}}).done(function(t){v--,t.Accepted?(m++,console.log("upload succeeded",t.Warnings),g&&g("Uploaded",t.Warnings.toString(),e),m>=n.recordings&&0===v&&S()):(console.log("upload error",t.Error),g&&g(t.Error),m<1?u("NoFaceFound",!0):(b=!1,S()))}).fail(function(e,t,i){console.log("upload failed",t,i,e.responseText),P(),u(i)});m+v<n.recordings&&function(){if(n.challengeResponse){let e=m+v;if(e>0&&e<n.recordings)if(I.length>=e)y=I[e-1];else{let t=y;if(e%2==1){let i=Math.random();t=1===e?i<.25?"up":i<.5?"down":i<.75?"left":"right":"up"===y||"down"===y?i<.5?"left":"right":i<.5?"up":"down"}else switch(y){case"left":t="right";break;case"right":t="left";break;case"up":t="down";break;case"down":t="up"}console.log("Switched tag for recording #"+e+" from "+y+" to "+t),y=t}else y="any"}g&&g("DisplayTag",y);b&&(b=!1,setTimeout(function(){null!==w&&(b=!0)},1e3))}()}}function S(){clearInterval(s);let e=n.apiurl;"enrollment"===n.task?e+="enroll":"identification"===n.task?e+="identify":"livenessdetection"===n.task?e+="livenessdetection":e+="verify",g&&g("Perform-"+n.task);t.ajax({type:"GET",url:e,headers:{Authorization:"Bearer "+a}}).done(function(e,t,i){if(e.Success)console.log("task succeeded"),P(),u();else{console.log("task failed",e.Error);let t=e.Error?e.Error:"NotRecognized";g&&g(t),T(!1),u(t,"NoTemplateAvailable"!==t)}}).fail(function(e,t,i){console.log("task failed",t,i,e.responseText),P(),u(i)})}return{start:function(e,t,i,o){if(console.log("Starting capture..."),u=i,g=o,!h){var a={audio:!1,video:{facingMode:"user"}};navigator.mediaDevices.getUserMedia(a).then(function(t){console.log("Video capture stream has been created with constraints:",a),h=t,l.srcObject=t,l.onloadedmetadata=function(t){l.play(),console.log("Playing live media stream"),function(){r.width=r.clientWidth,r.height=r.clientHeight;let e=l.videoWidth/l.videoHeight<.75?l.videoWidth/l.videoHeight:.75;f.height=l.videoHeight>n.maxheight?n.maxheight:l.videoHeight,f.width=f.height*e,p.height=n.motionareaheight,p.width=p.height*e,n.mirror&&U(),d=setInterval(k,50)}(),console.log("capture started"),e()}}).catch(function(e){console.log("getUserMedia failed with error:",e),t(e)})}},stop:P,startRecording:function(e,t){T(!1),I=e||[],t&&g?(g("UserInstruction-3"),setTimeout(function(){g("UserInstruction-2")},400),setTimeout(function(){g("UserInstruction-1")},800),setTimeout(E,1200)):E()},stopRecording:function(){T(!1)},upload:R,mirror:U,getUploading:function(){return v},getUploaded:function(){return m}}}}(window.bws=window.bws||{},jQuery);